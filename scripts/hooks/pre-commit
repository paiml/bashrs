#!/bin/bash
# bashrs pre-commit hook: Zero tolerance for lint warnings
# Enforces code quality standards before commit

set -e

echo "üîç Running pre-commit quality checks..."

# Run clippy with zero-tolerance mode
echo "  üìã Checking clippy (zero warnings required)..."
if ! cargo clippy --lib -- -D warnings 2>&1 | tail -10; then
    echo ""
    echo "‚ùå COMMIT BLOCKED: Clippy warnings detected"
    echo ""
    echo "Fix all warnings before committing:"
    echo "  cargo clippy --lib -- -D warnings"
    echo ""
    echo "Or fix automatically where possible:"
    echo "  cargo clippy --lib --fix --allow-dirty"
    echo ""
    exit 1
fi

echo "  ‚úÖ Clippy: Zero warnings"

# Run clippy performance checks (release mode)
echo "  ‚ö° Checking performance lints (release mode)..."
if ! cargo clippy --release -- -W clippy::perf 2>&1 | tail -10; then
    echo ""
    echo "‚ùå COMMIT BLOCKED: Performance issues detected"
    echo ""
    echo "Fix performance issues before committing:"
    echo "  cargo clippy --release -- -W clippy::perf"
    echo ""
    exit 1
fi

echo "  ‚úÖ Performance: No issues"

# Run tests to ensure no regressions (fast mode: 50 property test cases)
echo "  üß™ Running tests (fast: 50 prop cases)..."
if ! PROPTEST_CASES=50 cargo test --lib --quiet 2>&1 | tail -5; then
    echo ""
    echo "‚ùå COMMIT BLOCKED: Tests failing"
    echo ""
    echo "Fix failing tests before committing:"
    echo "  make test-fast"
    echo "  Or: PROPTEST_CASES=50 cargo test --lib"
    echo ""
    exit 1
fi

echo "  ‚úÖ Tests: All passing (50 prop cases)"

echo ""
echo "‚úÖ Pre-commit checks passed - proceeding with commit"
echo ""
