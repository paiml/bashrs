name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUSTFLAGS: -Dwarnings

jobs:
  # MSRV check - verify minimum supported Rust version
  msrv:
    name: MSRV (rust: 1.82)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.82
      - run: cargo check --lib

  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check
        run: cargo check --all-features --workspace

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Format check
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Clippy (all features)
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Clippy (no default features)
        run: cargo clippy --all-targets --no-default-features -- -D warnings

  # Feature matrix - test minimal, default, and full feature combinations
  features:
    name: Feature Matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        features: [minimal, default, full]
        include:
          - features: minimal
            flags: "--no-default-features"
          - features: default
            flags: ""
          - features: full
            flags: "--all-features"
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check (${{ matrix.features }})
        run: cargo check ${{ matrix.flags }}

  test:
    name: Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - uses: Swatinem/rust-cache@v2

    - name: Run tests
      run: cargo test --all-features --workspace

    - name: Run doc tests
      run: cargo test --doc

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - uses: Swatinem/rust-cache@v2

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate coverage
      run: cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info

    - name: Upload coverage
      uses: codecov/codecov-action@v4
      with:
        files: lcov.info
        fail_ci_if_error: false

  mutants:
    name: Mutation Testing
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-mutants
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-mutants
      - name: Run mutation tests (sample)
        run: cargo mutants --no-times --timeout 300 --in-place -- --all-features
        continue-on-error: true
      - name: Upload mutants results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutants-results
          path: mutants.out/
          retention-days: 30

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Dependency Check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2

  miri:
    name: Miri (Undefined Behavior Detection)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri
      - uses: Swatinem/rust-cache@v2
      - name: Run Miri on core library (no FFI/IO)
        run: |
          cargo +nightly miri test --lib --no-default-features -- \
            --skip fuzz --skip golden --skip tempfile --skip file \
            --skip serializ --skip compile --skip tui
        env:
          MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-permissive-provenance

  kani:
    name: Kani (Bounded Model Checking)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Install Kani
        run: |
          cargo install --locked kani-verifier || true
          cargo kani setup || true
      - name: Run Kani proofs
        run: |
          if command -v cargo-kani &> /dev/null; then
            cargo kani || true
          else
            echo "::warning::Kani not available - skipping proof verification"
          fi

  corpus-validation:
    name: Corpus Quality Gate (Jidoka)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: llvm-tools-preview

    - uses: Swatinem/rust-cache@v2

    - name: Install shellcheck
      run: sudo apt-get update && sudo apt-get install -y shellcheck dash

    - name: Install cargo-llvm-cov
      uses: taiki-e/install-action@cargo-llvm-cov

    - name: Generate LCOV for corpus coverage dimension
      run: cargo llvm-cov --lcov --lib --output-path target/coverage/lcov.info

    - name: Build bashrs
      run: cargo build --release --bin bashrs

    - name: Run corpus validation
      run: |
        # Run corpus and capture output
        OUTPUT=$(./target/release/bashrs corpus run --log 2>&1)
        echo "$OUTPUT"

        # Extract score from output (e.g. "V2 Corpus Score: 99.9/100")
        SCORE=$(echo "$OUTPUT" | grep -oP 'Score: \K[0-9.]+(?=/100)')
        echo "Corpus score: ${SCORE}/100"

        # Andon Cord: fail if score < 99.0
        if command -v bc >/dev/null 2>&1; then
          if (( $(echo "$SCORE < 99.0" | bc -l) )); then
            echo "::error::ANDON CORD: Corpus score ${SCORE}/100 is below 99.0 threshold"
            exit 1
          else
            echo "Corpus quality gate PASSED: ${SCORE}/100 >= 99.0"
          fi
        fi

    - name: Upload convergence log
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: convergence-log
        path: .quality/convergence.log

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
    - name: Run benchmarks
      run: cargo bench --workspace --no-fail-fast
      timeout-minutes: 15

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [check, fmt, clippy, test, security]
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Build release
      run: cargo build --release --workspace

    - name: Test release build
      run: ./target/release/bashrs --version
      shell: bash

    - name: Upload binary
      uses: actions/upload-artifact@v4
      with:
        name: bashrs-linux
        path: target/release/bashrs*

  shellcheck-validation:
    name: ShellCheck Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install ShellCheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Build bashrs
      run: cargo build --release --workspace

    - name: Run ShellCheck validation
      run: make shellcheck-validate

  performance:
    name: Performance Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - uses: Swatinem/rust-cache@v2

    - name: Install renacer
      run: |
        cargo install renacer --version 0.6.2 || echo "Using existing renacer installation"

    - name: Build release binary
      run: cargo build --release --bin bashrs

    - name: Capture golden traces
      run: |
        chmod +x scripts/capture_all_golden_traces.sh
        ./scripts/capture_all_golden_traces.sh

    - name: Upload golden traces
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: golden-traces
        path: golden_traces/

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2
    - name: Build docs
      run: cargo doc --no-deps --all-features --workspace
      env:
        RUSTDOCFLAGS: -Dwarnings

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Shellcheck
        run: shellcheck --severity=error scripts/*.sh
        continue-on-error: true
