name: Book Accuracy Validation

on:
  push:
    branches: [ main ]
    paths:
      - 'rash-book/src/**/*.md'
      - 'README.md'
      - 'rash/tests/book_validation.rs'
  pull_request:
    branches: [ main ]
    paths:
      - 'rash-book/src/**/*.md'
      - 'README.md'
      - 'rash/tests/book_validation.rs'

jobs:
  validate-book:
    name: Validate Book Examples
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: rustc

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Run book validation tests
        run: cargo test --test book_validation -- --nocapture

      - name: Check book accuracy standards
        run: |
          echo "üìä Book Accuracy Policy:"
          echo "  - Chapter 21+: Must maintain 90%+ accuracy (executable examples)"
          echo "  - Chapters 1-5: Educational format (code fragments)"
          echo ""
          echo "‚úÖ Validation complete - see test output above"

      - name: Report results
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ All book validation tests passed"
          else
            echo "‚ùå Book validation tests failed"
            echo "Please ensure:"
            echo "  1. All Rust code examples in Chapter 21+ compile successfully"
            echo "  2. Code blocks use correct language tags (rust, sh, bash, ignore)"
            echo "  3. Examples are complete programs with fn main() when needed"
            exit 1
          fi
