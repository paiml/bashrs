name: Dogfooding (Self-Validation)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

env:
  CARGO_TERM_COLOR: always

jobs:
  dogfood:
    name: bashrs Self-Validation
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-dogfood-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-dogfood-
          ${{ runner.os }}-cargo-

    - name: Build bashrs
      run: cargo build --release --bin bashrs

    - name: Dogfood - Lint Makefile
      id: makefile
      continue-on-error: true
      run: |
        echo "## Makefile Lint Results" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        ./target/release/bashrs make lint Makefile --format human 2>&1 | tee /tmp/makefile-lint.txt || true
        cat /tmp/makefile-lint.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

        # Extract metrics
        ERRORS=$(grep -oP '\d+ error' /tmp/makefile-lint.txt | grep -oP '\d+' || echo "0")
        WARNINGS=$(grep -oP '\d+ warning' /tmp/makefile-lint.txt | grep -oP '\d+' || echo "0")
        echo "makefile_errors=$ERRORS" >> $GITHUB_OUTPUT
        echo "makefile_warnings=$WARNINGS" >> $GITHUB_OUTPUT

    - name: Dogfood - Lint Shell Scripts
      id: scripts
      continue-on-error: true
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Shell Script Lint Summary" >> $GITHUB_STEP_SUMMARY

        TOTAL_SCRIPTS=0
        TOTAL_ERRORS=0
        TOTAL_WARNINGS=0
        TOTAL_INFOS=0

        for script in $(find . -name "*.sh" -type f ! -path "*/node_modules/*" ! -path "*/target/*"); do
          TOTAL_SCRIPTS=$((TOTAL_SCRIPTS + 1))
          RESULT=$(./target/release/bashrs lint "$script" --format human 2>&1 | grep "^Summary:" | tail -1 || echo "Summary: 0 error(s), 0 warning(s), 0 info(s)")

          if [[ "$RESULT" =~ ([0-9]+)\ error ]]; then
            TOTAL_ERRORS=$((TOTAL_ERRORS + ${BASH_REMATCH[1]}))
          fi
          if [[ "$RESULT" =~ ([0-9]+)\ warning ]]; then
            TOTAL_WARNINGS=$((TOTAL_WARNINGS + ${BASH_REMATCH[1]}))
          fi
          if [[ "$RESULT" =~ ([0-9]+)\ info ]]; then
            TOTAL_INFOS=$((TOTAL_INFOS + ${BASH_REMATCH[1]}))
          fi
        done

        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Shell scripts scanned | $TOTAL_SCRIPTS |" >> $GITHUB_STEP_SUMMARY
        echo "| Total errors | $TOTAL_ERRORS |" >> $GITHUB_STEP_SUMMARY
        echo "| Total warnings | $TOTAL_WARNINGS |" >> $GITHUB_STEP_SUMMARY
        echo "| Total infos | $TOTAL_INFOS |" >> $GITHUB_STEP_SUMMARY

        echo "scripts_count=$TOTAL_SCRIPTS" >> $GITHUB_OUTPUT
        echo "scripts_errors=$TOTAL_ERRORS" >> $GITHUB_OUTPUT
        echo "scripts_warnings=$TOTAL_WARNINGS" >> $GITHUB_OUTPUT

    - name: Dogfood Summary
      run: |
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Dogfooding Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "bashrs successfully validated its own codebase!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Makefile**: ${{ steps.makefile.outputs.makefile_errors }} errors, ${{ steps.makefile.outputs.makefile_warnings }} warnings" >> $GITHUB_STEP_SUMMARY
        echo "- **Shell Scripts**: ${{ steps.scripts.outputs.scripts_count }} files, ${{ steps.scripts.outputs.scripts_errors }} errors, ${{ steps.scripts.outputs.scripts_warnings }} warnings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "See [dogfooding documentation](docs/dogfooding/BASHRS_DOGFOODING.md) for details." >> $GITHUB_STEP_SUMMARY

  synthetic-tests:
    name: Synthetic Test Corpus
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-synthetic-${{ hashFiles('**/Cargo.lock') }}

    - name: Build bashrs
      run: cargo build --release --bin bashrs

    - name: Generate Synthetic Corpus
      run: |
        echo "## Synthetic Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Create test scripts from various bash patterns
        mkdir -p /tmp/synthetic

        # Pattern 1: Assignments
        for var in x y result; do
          for val in 1 0 42 hello world; do
            echo "#!/bin/sh" > "/tmp/synthetic/${var}_${val}.sh"
            echo "${var}=${val}" >> "/tmp/synthetic/${var}_${val}.sh"
          done
        done

        # Pattern 2: Echo
        echo '#!/bin/sh
        echo "$x"' > /tmp/synthetic/echo_var.sh
        echo '#!/bin/sh
        echo hello' > /tmp/synthetic/echo_literal.sh
        echo '#!/bin/sh
        echo "$HOME"' > /tmp/synthetic/echo_env.sh

        # Pattern 3: Conditionals
        echo '#!/bin/sh
        if [ "$x" -eq 0 ]; then
            echo yes
        fi' > /tmp/synthetic/if_eq.sh

        # Pattern 4: Loops
        echo '#!/bin/sh
        for i in 1 2 3; do
            echo "$i"
        done' > /tmp/synthetic/for_loop.sh

        # Pattern 5: Functions
        echo '#!/bin/sh
        greet() {
            echo hello
        }' > /tmp/synthetic/function.sh

        # Pattern 6: Arithmetic
        echo '#!/bin/sh
        result=$((1 + 2))' > /tmp/synthetic/arithmetic.sh

        # Pattern 7: Pipes
        echo '#!/bin/sh
        echo hello | wc -c' > /tmp/synthetic/pipe.sh

        # Count generated programs
        SYNTHETIC_COUNT=$(ls -1 /tmp/synthetic/*.sh | wc -l)
        echo "Generated $SYNTHETIC_COUNT synthetic programs" >> $GITHUB_STEP_SUMMARY

        # Test all
        PASSED=0
        FAILED=0
        for script in /tmp/synthetic/*.sh; do
          if ./target/release/bashrs lint "$script" --format human 2>&1 | grep -q "0 error"; then
            PASSED=$((PASSED + 1))
          else
            FAILED=$((FAILED + 1))
          fi
        done

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Programs tested | $SYNTHETIC_COUNT |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed (no errors) | $PASSED |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed (has errors) | $FAILED |" >> $GITHUB_STEP_SUMMARY
