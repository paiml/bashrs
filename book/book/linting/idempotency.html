<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Idempotency Rules (IDEM001-IDEM003) - The Rash Book - Shell Safety and Purification</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A comprehensive guide to Rash: shell safety, purification, and linting">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rash Book - Shell Safety and Purification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs/edit/main/book/src/linting/idempotency.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="idempotency-rules-idem001-idem006"><a class="header" href="#idempotency-rules-idem001-idem006">Idempotency Rules (IDEM001-IDEM006)</a></h1>
<p>Rash includes idempotency rules designed to detect operations that fail when run multiple times. Idempotent scripts can be <strong>safely re-run</strong> without side effects or failures, making them reliable for automation and recovery.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Idempotency linting in Rash focuses on operations that fail on second execution:</p>
<ul>
<li>Directory creation without <code>-p</code> (<code>mkdir</code>)</li>
<li>File removal without <code>-f</code> (<code>rm</code>)</li>
<li>Symlink creation without cleanup (<code>ln -s</code>)</li>
<li>Non-idempotent variable appends</li>
<li>File creation with <code>&gt;</code> (truncating)</li>
<li>Database inserts without existence checks</li>
</ul>
<p>All IDEM rules are <strong>Warning severity</strong> by default to indicate improvements without blocking.</p>
<h2 id="why-idempotency-matters"><a class="header" href="#why-idempotency-matters">Why Idempotency Matters</a></h2>
<p>Non-idempotent scripts cause:</p>
<ul>
<li><strong>Deployment failures</strong>: Re-running fails instead of succeeding</li>
<li><strong>Recovery problems</strong>: Can't safely retry after partial failures</li>
<li><strong>Automation issues</strong>: Cron jobs and systemd timers break</li>
<li><strong>Manual headaches</strong>: Operators fear running scripts twice</li>
<li><strong>Rollback failures</strong>: Can't cleanly undo then redo</li>
</ul>
<p><strong>Idempotent = Safe to Re-run = Reliable</strong></p>
<h2 id="core-principle"><a class="header" href="#core-principle">Core Principle</a></h2>
<p>An operation is idempotent if:</p>
<pre><code class="language-text">f(x) = f(f(x)) = f(f(f(x))) = ...
</code></pre>
<p>Running it once or N times produces the same result.</p>
<h2 id="implemented-rules-idem001-idem003"><a class="header" href="#implemented-rules-idem001-idem003">Implemented Rules (IDEM001-IDEM003)</a></h2>
<p>bashrs currently implements 3 idempotency rules with comprehensive testing. The remaining rules (IDEM004-IDEM006) are planned for future releases.</p>
<h2 id="idem001-non-idempotent-mkdir"><a class="header" href="#idem001-non-idempotent-mkdir">IDEM001: Non-idempotent mkdir</a></h2>
<p><strong>Severity</strong>: Warning</p>
<h3 id="what-it-detects"><a class="header" href="#what-it-detects">What it Detects</a></h3>
<p><code>mkdir</code> commands without the <code>-p</code> flag.</p>
<h3 id="why-this-matters"><a class="header" href="#why-this-matters">Why This Matters</a></h3>
<p><code>mkdir</code> without <code>-p</code> fails if the directory already exists:</p>
<pre><code class="language-bash">$ mkdir /app/releases
$ mkdir /app/releases  # FAILS with "File exists" error
mkdir: cannot create directory '/app/releases': File exists
</code></pre>
<p>This breaks idempotency - the script fails on second run even though the desired state (directory exists) is achieved.</p>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> deploy.sh - FAILS on second run
</span>
mkdir /app/releases
mkdir /app/releases/v1.0.0
ln -s /app/releases/v1.0.0 /app/current
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First run:  ✅ SUCCESS - directories created
Second run: ❌ FAILURE - mkdir fails with "File exists"
</code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> deploy.sh - SAFE to re-run
</span>
mkdir -p /app/releases
mkdir -p /app/releases/v1.0.0
rm -f /app/current &amp;&amp; ln -s /app/releases/v1.0.0 /app/current
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First run:  ✅ SUCCESS - directories created
Second run: ✅ SUCCESS - no-op (directories exist)
Third run:  ✅ SUCCESS - still safe!
</code></pre>
<h3 id="auto-fix"><a class="header" href="#auto-fix">Auto-fix</a></h3>
<p><strong>Auto-fixable with assumptions</strong> - automatically adds <code>-p</code> flag.</p>
<p><strong>Assumption</strong>: Directory creation failure is not a critical error condition.</p>
<p>If directory creation failure MUST be detected (rare), keep <code>mkdir</code> without <code>-p</code> and explicitly handle errors:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> Only use this if you NEED to detect pre-existing directories
</span>if ! mkdir /app/releases 2&gt;/dev/null; then
    echo "ERROR: Directory /app/releases already exists or cannot be created"
    exit 1
fi
</code></pre>
<h3 id="testing-for-idempotency"><a class="header" href="#testing-for-idempotency">Testing for Idempotency</a></h3>
<p>Verify scripts can run multiple times:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> test-idempotency.sh
</span>
SCRIPT="$1"

echo "Testing idempotency of: $SCRIPT"

<span class="boring"> Run once
</span>"$SCRIPT"
RESULT1=$?

<span class="boring"> Run twice
</span>"$SCRIPT"
RESULT2=$?

<span class="boring"> Both should succeed
</span>if [ $RESULT1 -eq 0 ] &amp;&amp; [ $RESULT2 -eq 0 ]; then
    echo "✅ PASS: Script is idempotent"
else
    echo "❌ FAIL: Script is not idempotent"
    echo "First run: exit $RESULT1"
    echo "Second run: exit $RESULT2"
    exit 1
fi
</code></pre>
<h3 id="real-world-example-application-setup"><a class="header" href="#real-world-example-application-setup">Real-world Example: Application Setup</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> setup.sh - FAILS on re-run
</span>
<span class="boring"> Create directory structure
</span>mkdir /opt/myapp
mkdir /opt/myapp/bin
mkdir /opt/myapp/lib
mkdir /opt/myapp/data

<span class="boring"> Install application
</span>cp myapp /opt/myapp/bin/
cp lib/*.so /opt/myapp/lib/

<span class="boring"> Second run FAILS at first mkdir!
</span></code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> setup.sh - SAFE to re-run
</span>
<span class="boring"> Create directory structure (idempotent)
</span>mkdir -p /opt/myapp/bin
mkdir -p /opt/myapp/lib
mkdir -p /opt/myapp/data

<span class="boring"> Install application (use -f to force overwrite)
</span>cp -f myapp /opt/myapp/bin/
cp -f lib/*.so /opt/myapp/lib/

<span class="boring"> Safe to run multiple times - always succeeds!
</span></code></pre>
<h2 id="idem002-non-idempotent-rm"><a class="header" href="#idem002-non-idempotent-rm">IDEM002: Non-idempotent rm</a></h2>
<p><strong>Severity</strong>: Warning</p>
<h3 id="what-it-detects-1"><a class="header" href="#what-it-detects-1">What it Detects</a></h3>
<p><code>rm</code> commands without the <code>-f</code> flag.</p>
<h3 id="why-this-matters-1"><a class="header" href="#why-this-matters-1">Why This Matters</a></h3>
<p><code>rm</code> without <code>-f</code> fails if the file doesn't exist:</p>
<pre><code class="language-bash">$ rm /app/current
$ rm /app/current  # FAILS with "No such file or directory"
rm: cannot remove '/app/current': No such file or directory
</code></pre>
<p>This breaks idempotency - the script fails on second run even though the desired state (file doesn't exist) is achieved.</p>
<h3 id="examples-1"><a class="header" href="#examples-1">Examples</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> cleanup.sh - FAILS on second run
</span>
rm /tmp/build.log
rm /tmp/cache.dat
rm /app/old-version
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First run:  ✅ SUCCESS - files deleted
Second run: ❌ FAILURE - rm fails with "No such file"
</code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> cleanup.sh - SAFE to re-run
</span>
rm -f /tmp/build.log
rm -f /tmp/cache.dat
rm -f /app/old-version
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First run:  ✅ SUCCESS - files deleted
Second run: ✅ SUCCESS - no-op (files don't exist)
Third run:  ✅ SUCCESS - still safe!
</code></pre>
<h3 id="auto-fix-1"><a class="header" href="#auto-fix-1">Auto-fix</a></h3>
<p><strong>Auto-fixable with assumptions</strong> - automatically adds <code>-f</code> flag.</p>
<p><strong>Assumption</strong>: Missing file is not an error condition.</p>
<p>If file existence MUST be verified (rare), explicitly check before removing:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> Only use this if you NEED to ensure file exists
</span>if [ ! -f /app/critical-file ]; then
    echo "ERROR: Expected file /app/critical-file not found"
    exit 1
fi

rm /app/critical-file
</code></pre>
<h3 id="when-to-use-rm-without--f"><a class="header" href="#when-to-use-rm-without--f">When to Use rm Without -f</a></h3>
<p>Very rare cases where missing file indicates a problem:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> uninstall.sh - Verify installed before uninstalling
</span>
<span class="boring"> Check installation exists
</span>if [ ! -f /usr/local/bin/myapp ]; then
    echo "ERROR: myapp not installed (expected /usr/local/bin/myapp)"
    exit 1
fi

<span class="boring"> Remove (without -f to detect unexpected deletion)
</span>rm /usr/local/bin/myapp
</code></pre>
<p>But even here, idempotent version is usually better:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> uninstall.sh - Idempotent version
</span>
<span class="boring"> Idempotent: remove if exists, succeed if not
</span>rm -f /usr/local/bin/myapp

<span class="boring"> Report status
</span>if [ -f /usr/local/bin/myapp ]; then
    echo "ERROR: Failed to remove /usr/local/bin/myapp"
    exit 1
else
    echo "✅ myapp uninstalled (or was already removed)"
fi
</code></pre>
<h3 id="real-world-example-log-rotation"><a class="header" href="#real-world-example-log-rotation">Real-world Example: Log Rotation</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> rotate-logs.sh - FAILS on second run
</span>
<span class="boring"> Rotate logs
</span>mv /var/log/app.log /var/log/app.log.1
rm /var/log/app.log.2  # FAILS if doesn't exist!

<span class="boring"> Restart app to create fresh log
</span>systemctl restart myapp
</code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> rotate-logs.sh - SAFE to re-run
</span>
<span class="boring"> Rotate logs (idempotent - -f means no error if missing)
</span>rm -f /var/log/app.log.2
mv -f /var/log/app.log.1 /var/log/app.log.2 2&gt;/dev/null || true
mv -f /var/log/app.log /var/log/app.log.1 2&gt;/dev/null || true

<span class="boring"> Restart app to create fresh log
</span>systemctl restart myapp

<span class="boring"> Safe to run multiple times!
</span></code></pre>
<h2 id="idem003-non-idempotent-ln--s"><a class="header" href="#idem003-non-idempotent-ln--s">IDEM003: Non-idempotent ln -s</a></h2>
<p><strong>Severity</strong>: Warning</p>
<h3 id="what-it-detects-2"><a class="header" href="#what-it-detects-2">What it Detects</a></h3>
<p><code>ln -s</code> (symbolic link creation) without removing existing link first.</p>
<h3 id="why-this-matters-2"><a class="header" href="#why-this-matters-2">Why This Matters</a></h3>
<p><code>ln -s</code> fails if the target already exists:</p>
<pre><code class="language-bash">$ ln -s /app/v1.0.0 /app/current
$ ln -s /app/v1.0.0 /app/current  # FAILS
ln: failed to create symbolic link '/app/current': File exists
</code></pre>
<p>This is especially problematic for deployment scripts that update symlinks.</p>
<h3 id="examples-2"><a class="header" href="#examples-2">Examples</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> deploy.sh - FAILS on second run
</span>
VERSION="$1"
RELEASE_DIR="/app/releases/$VERSION"

<span class="boring"> Create symlink (FAILS if exists)
</span>ln -s "$RELEASE_DIR" /app/current
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First deploy (v1.0.0):  ✅ SUCCESS - symlink created
Second deploy (v1.0.0): ❌ FAILURE - ln fails with "File exists"
Update deploy (v1.0.1): ❌ FAILURE - ln fails, current still points to v1.0.0!
</code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> deploy.sh - SAFE to re-run
</span>
VERSION="$1"
RELEASE_DIR="/app/releases/$VERSION"

<span class="boring"> Remove old symlink first (idempotent)
</span>rm -f /app/current

<span class="boring"> Create new symlink
</span>ln -s "$RELEASE_DIR" /app/current
</code></pre>
<p><strong>Behavior</strong>:</p>
<pre><code class="language-text">First deploy (v1.0.0):  ✅ SUCCESS - symlink created to v1.0.0
Second deploy (v1.0.0): ✅ SUCCESS - symlink recreated (no-op)
Update deploy (v1.0.1): ✅ SUCCESS - symlink updated to v1.0.1!
</code></pre>
<h3 id="auto-fix-options"><a class="header" href="#auto-fix-options">Auto-fix Options</a></h3>
<p><strong>Not auto-fixable</strong> - requires manual choice of strategy.</p>
<p><strong>Option 1: Remove then link</strong> (recommended):</p>
<pre><code class="language-bash">rm -f /target &amp;&amp; ln -s /source /target
</code></pre>
<p><strong>Option 2: ln -sf flag</strong> (not always portable):</p>
<pre><code class="language-bash"><span class="boring"> Works on Linux, may not work on some Unix systems
</span>ln -sf /source /target
</code></pre>
<p><strong>Option 3: Conditional link</strong> (explicit):</p>
<pre><code class="language-bash">[ -e /target ] &amp;&amp; rm /target
ln -s /source /target
</code></pre>
<h3 id="testing-for-idempotency-1"><a class="header" href="#testing-for-idempotency-1">Testing for Idempotency</a></h3>
<p>Verify symlink update works:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> test-symlink-idempotency.sh
</span>
SCRIPT="./deploy.sh"

echo "Testing symlink idempotency"

<span class="boring"> Deploy v1.0.0
</span>"$SCRIPT" v1.0.0
TARGET1=$(readlink /app/current)

<span class="boring"> Deploy v1.0.0 again (idempotent)
</span>"$SCRIPT" v1.0.0
TARGET2=$(readlink /app/current)

<span class="boring"> Update to v1.0.1
</span>"$SCRIPT" v1.0.1
TARGET3=$(readlink /app/current)

<span class="boring"> Verify results
</span>if [ "$TARGET1" = "/app/releases/v1.0.0" ] &amp;&amp;
   [ "$TARGET2" = "/app/releases/v1.0.0" ] &amp;&amp;
   [ "$TARGET3" = "/app/releases/v1.0.1" ]; then
    echo "✅ PASS: Symlink updates are idempotent"
else
    echo "❌ FAIL: Symlink not idempotent"
    echo "Deploy 1: $TARGET1"
    echo "Deploy 2: $TARGET2"
    echo "Deploy 3: $TARGET3"
    exit 1
fi
</code></pre>
<h3 id="real-world-example-blue-green-deployment"><a class="header" href="#real-world-example-blue-green-deployment">Real-world Example: Blue-Green Deployment</a></h3>
<p>❌ <strong>NON-IDEMPOTENT (BAD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> switch-version.sh - FAILS on re-run
</span>
NEW_VERSION="$1"
BLUE_DIR="/srv/app-blue"
GREEN_DIR="/srv/app-green"

<span class="boring"> Determine which slot is active
</span>if [ -L /srv/app-current ] &amp;&amp; [ "$(readlink /srv/app-current)" = "$BLUE_DIR" ]; then
    INACTIVE_DIR="$GREEN_DIR"
else
    INACTIVE_DIR="$BLUE_DIR"
fi

<span class="boring"> Deploy to inactive slot
</span>rsync -a "dist/" "$INACTIVE_DIR/"

<span class="boring"> Switch symlink (FAILS if already switched!)
</span>ln -s "$INACTIVE_DIR" /srv/app-current
</code></pre>
<p>✅ <strong>IDEMPOTENT (GOOD)</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> switch-version.sh - SAFE to re-run
</span>
NEW_VERSION="$1"
BLUE_DIR="/srv/app-blue"
GREEN_DIR="/srv/app-green"

<span class="boring"> Determine which slot is active
</span>if [ -L /srv/app-current ] &amp;&amp; [ "$(readlink /srv/app-current)" = "$BLUE_DIR" ]; then
    INACTIVE_DIR="$GREEN_DIR"
else
    INACTIVE_DIR="$BLUE_DIR"
fi

<span class="boring"> Deploy to inactive slot
</span>rsync -a "dist/" "$INACTIVE_DIR/"

<span class="boring"> Switch symlink (idempotent - remove first)
</span>rm -f /srv/app-current
ln -s "$INACTIVE_DIR" /srv/app-current

<span class="boring"> Safe to run multiple times!
</span></code></pre>
<h2 id="idem004-non-idempotent-variable-appends-planned"><a class="header" href="#idem004-non-idempotent-variable-appends-planned">IDEM004: Non-idempotent Variable Appends (Planned)</a></h2>
<p><strong>Status</strong>: Not yet implemented</p>
<h3 id="what-it-will-detect"><a class="header" href="#what-it-will-detect">What it Will Detect</a></h3>
<p>Variable append operations that duplicate values on re-run:</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>PATH="$PATH:/opt/myapp/bin"
<span class="boring"> Second run: PATH has /opt/myapp/bin twice!
</span></code></pre>
<h3 id="why-this-will-matter"><a class="header" href="#why-this-will-matter">Why This Will Matter</a></h3>
<p>Repeated execution causes:</p>
<ul>
<li>PATH pollution with duplicates</li>
<li>Growing environment variables</li>
<li>Performance degradation (PATH search)</li>
</ul>
<h3 id="planned-fix"><a class="header" href="#planned-fix">Planned Fix</a></h3>
<p>Use idempotent append pattern:</p>
<pre><code class="language-bash"><span class="boring"> Idempotent - only add if not present
</span>if [[ ":$PATH:" != *":/opt/myapp/bin:"* ]]; then
    PATH="$PATH:/opt/myapp/bin"
fi
</code></pre>
<h2 id="idem005-file-creation-with--planned"><a class="header" href="#idem005-file-creation-with--planned">IDEM005: File Creation with &gt; (Planned)</a></h2>
<p><strong>Status</strong>: Not yet implemented</p>
<h3 id="what-it-will-detect-1"><a class="header" href="#what-it-will-detect-1">What it Will Detect</a></h3>
<p>File creation with <code>&gt;</code> that truncates existing content:</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>echo "data" &gt; /var/lib/myapp/config
<span class="boring"> Re-run appends "data" again? Truncates? Unclear!
</span></code></pre>
<h3 id="why-this-will-matter-1"><a class="header" href="#why-this-will-matter-1">Why This Will Matter</a></h3>
<p><code>&gt;</code> truncates files, making behavior unclear:</p>
<ul>
<li>Loses existing data on re-run</li>
<li>Not obvious if intentional</li>
<li>Hard to reason about state</li>
</ul>
<h3 id="planned-fix-1"><a class="header" href="#planned-fix-1">Planned Fix</a></h3>
<p>Use explicit patterns:</p>
<pre><code class="language-bash"><span class="boring"> Idempotent - only create if doesn't exist
</span>if [ ! -f /var/lib/myapp/config ]; then
    echo "data" &gt; /var/lib/myapp/config
fi

<span class="boring"> Or use &gt;&gt; for append (but check for duplicates)
</span>grep -qF "data" /var/lib/myapp/config || echo "data" &gt;&gt; /var/lib/myapp/config
</code></pre>
<h2 id="idem006-database-inserts-without-checks-planned"><a class="header" href="#idem006-database-inserts-without-checks-planned">IDEM006: Database Inserts Without Checks (Planned)</a></h2>
<p><strong>Status</strong>: Not yet implemented</p>
<h3 id="what-it-will-detect-2"><a class="header" href="#what-it-will-detect-2">What it Will Detect</a></h3>
<p>SQL inserts without existence checks:</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent - fails on second run if unique constraint
</span>mysql -e "INSERT INTO users VALUES (1, 'admin')"
</code></pre>
<h3 id="why-this-will-matter-2"><a class="header" href="#why-this-will-matter-2">Why This Will Matter</a></h3>
<p>Database operations often fail on duplicate:</p>
<ul>
<li>Unique constraint violations</li>
<li>Breaks migration scripts</li>
<li>Manual re-runs fail</li>
</ul>
<h3 id="planned-fix-2"><a class="header" href="#planned-fix-2">Planned Fix</a></h3>
<p>Use idempotent SQL patterns:</p>
<pre><code class="language-bash"><span class="boring"> Idempotent - upsert pattern
</span>mysql -e "INSERT INTO users VALUES (1, 'admin')
          ON DUPLICATE KEY UPDATE name='admin'"

<span class="boring"> Or check first
</span>mysql -e "INSERT INTO users SELECT 1, 'admin'
          WHERE NOT EXISTS (SELECT 1 FROM users WHERE id=1)"
</code></pre>
<h2 id="running-idempotency-linting"><a class="header" href="#running-idempotency-linting">Running Idempotency Linting</a></h2>
<h3 id="lint-a-single-file"><a class="header" href="#lint-a-single-file">Lint a Single File</a></h3>
<pre><code class="language-bash">bashrs lint script.sh
</code></pre>
<h3 id="filter-only-idempotency-rules"><a class="header" href="#filter-only-idempotency-rules">Filter Only Idempotency Rules</a></h3>
<pre><code class="language-bash">bashrs lint --rules IDEM script.sh
</code></pre>
<h3 id="lint-all-scripts"><a class="header" href="#lint-all-scripts">Lint All Scripts</a></h3>
<pre><code class="language-bash">find . -name "*.sh" -exec bashrs lint --rules IDEM {} \;
</code></pre>
<h3 id="cicd-integration"><a class="header" href="#cicd-integration">CI/CD Integration</a></h3>
<pre><code class="language-yaml"># .github/workflows/lint.yml
name: Idempotency Lint
on: [push, pull_request]
jobs:
  idempotency:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install bashrs
        run: cargo install bashrs
      - name: Check idempotency
        run: |
          find . -name "*.sh" -exec bashrs lint --rules IDEM {} \;
</code></pre>
<h2 id="testing-idempotency"><a class="header" href="#testing-idempotency">Testing Idempotency</a></h2>
<h3 id="property-based-testing"><a class="header" href="#property-based-testing">Property-Based Testing</a></h3>
<p>Verify scripts are idempotent:</p>
<pre><code class="language-rust ignore">use proptest::prelude::*;

proptest! {
    #[test]
    fn test_script_idempotent(input in "[a-z]{1,10}") {
        // Run script twice with same input
        let state1 = run_script(&amp;input);
        let state2 = run_script(&amp;input);

        // Final state MUST be identical
        prop_assert_eq!(state1, state2);
    }
}</code></pre>
<h3 id="manual-testing"><a class="header" href="#manual-testing">Manual Testing</a></h3>
<p>Run scripts multiple times and verify success:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> test-idempotency.sh
</span>
SCRIPT="$1"
RUNS=5

echo "Testing idempotency of: $SCRIPT"

for i in $(seq 1 $RUNS); do
    echo "Run $i..."
    if ! "$SCRIPT"; then
        echo "❌ FAIL: Run $i failed"
        exit 1
    fi
done

echo "✅ PASS: All $RUNS runs succeeded"
</code></pre>
<h3 id="state-verification"><a class="header" href="#state-verification">State Verification</a></h3>
<p>Verify final state is consistent:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> test-state-idempotency.sh
</span>
SCRIPT="$1"

echo "Testing state idempotency"

<span class="boring"> Run once and capture state
</span>"$SCRIPT"
STATE1=$(get_system_state)

<span class="boring"> Run again and capture state
</span>"$SCRIPT"
STATE2=$(get_system_state)

<span class="boring"> States should be identical
</span>if [ "$STATE1" = "$STATE2" ]; then
    echo "✅ PASS: System state is idempotent"
else
    echo "❌ FAIL: System state differs"
    diff &lt;(echo "$STATE1") &lt;(echo "$STATE2")
    exit 1
fi
</code></pre>
<h2 id="common-patterns"><a class="header" href="#common-patterns">Common Patterns</a></h2>
<h3 id="pattern-1-idempotent-directory-setup"><a class="header" href="#pattern-1-idempotent-directory-setup">Pattern 1: Idempotent Directory Setup</a></h3>
<p>Always use <code>-p</code>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> setup-dirs.sh
</span>
<span class="boring"> Idempotent directory creation
</span>mkdir -p /opt/myapp/{bin,lib,data,logs}
mkdir -p /var/log/myapp
mkdir -p /etc/myapp
</code></pre>
<h3 id="pattern-2-idempotent-cleanup"><a class="header" href="#pattern-2-idempotent-cleanup">Pattern 2: Idempotent Cleanup</a></h3>
<p>Always use <code>-f</code>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> cleanup.sh
</span>
<span class="boring"> Idempotent file removal
</span>rm -f /tmp/build-*
rm -f /var/cache/myapp/*
rm -rf /tmp/myapp-temp
</code></pre>
<h3 id="pattern-3-idempotent-symlinks"><a class="header" href="#pattern-3-idempotent-symlinks">Pattern 3: Idempotent Symlinks</a></h3>
<p>Remove before linking:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> update-links.sh
</span>
<span class="boring"> Idempotent symlink updates
</span>rm -f /usr/local/bin/myapp
ln -s /opt/myapp/v2.0/bin/myapp /usr/local/bin/myapp
</code></pre>
<h3 id="pattern-4-idempotent-configuration"><a class="header" href="#pattern-4-idempotent-configuration">Pattern 4: Idempotent Configuration</a></h3>
<p>Check before modifying:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> configure.sh
</span>
CONFIG_FILE="/etc/myapp/config"

<span class="boring"> Idempotent config line addition
</span>if ! grep -qF "setting=value" "$CONFIG_FILE"; then
    echo "setting=value" &gt;&gt; "$CONFIG_FILE"
fi
</code></pre>
<h2 id="benefits-of-idempotency"><a class="header" href="#benefits-of-idempotency">Benefits of Idempotency</a></h2>
<h3 id="reliable-automation"><a class="header" href="#reliable-automation">Reliable Automation</a></h3>
<p>Scripts can run repeatedly:</p>
<ul>
<li>Cron jobs safe to re-run</li>
<li>Systemd timers don't accumulate errors</li>
<li>CI/CD pipelines are resilient</li>
</ul>
<h3 id="easy-recovery"><a class="header" href="#easy-recovery">Easy Recovery</a></h3>
<p>Failed operations can be retried:</p>
<ul>
<li>Partial failures can be re-run</li>
<li>No manual cleanup needed</li>
<li>Rollbacks work cleanly</li>
</ul>
<h3 id="safe-operations"><a class="header" href="#safe-operations">Safe Operations</a></h3>
<p>Operators can run without fear:</p>
<ul>
<li>"Did I already run this?" - doesn't matter!</li>
<li>Re-running is safe</li>
<li>No destructive side effects</li>
</ul>
<h3 id="better-testing"><a class="header" href="#better-testing">Better Testing</a></h3>
<p>Tests are more reliable:</p>
<ul>
<li>Can run tests multiple times</li>
<li>No test pollution</li>
<li>Easier to debug</li>
</ul>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Idempotence">Idempotence (Wikipedia)</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/reference_appendices/glossary.html#term-Idempotency">Ansible Idempotency</a></li>
<li><a href="https://www.terraform.io/docs/glossary#idempotent">Infrastructure as Code: Idempotency</a></li>
</ul>
<hr />
<p><strong>Quality Guarantee</strong>: All IDEM rules undergo comprehensive testing including multiple-run verification to ensure idempotency detection is accurate.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../linting/determinism.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../linting/false-positives.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../linting/determinism.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../linting/false-positives.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
