<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Idempotency - The Rash Book - Shell Safety and Purification</title>


        <!-- Custom HTML head -->

        <meta name="description" content="A comprehensive guide to Rash: shell safety, purification, and linting">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Rash Book - Shell Safety and Purification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/paiml/bashrs/edit/main/book/src/concepts/idempotency.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="idempotency"><a class="header" href="#idempotency">Idempotency</a></h1>
<p><strong>Idempotency</strong> means that running an operation multiple times has the same effect as running it once. There are no errors, no side effects, and the system reaches the same final state regardless of how many times the script executes.</p>
<h2 id="definition"><a class="header" href="#definition">Definition</a></h2>
<p>An operation is <strong>idempotent</strong> if and only if:</p>
<p><strong>Running it multiple times = Running it once (same final state)</strong></p>
<p><strong>Formula</strong>: <code>f(f(state)) = f(state)</code> (consistent, every time)</p>
<h2 id="why-idempotency-matters"><a class="header" href="#why-idempotency-matters">Why Idempotency Matters</a></h2>
<h3 id="the-problem-non-idempotent-scripts"><a class="header" href="#the-problem-non-idempotent-scripts">The Problem: Non-Idempotent Scripts</a></h3>
<p>Non-idempotent scripts fail when re-run, making deployments and automation fragile:</p>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> Non-idempotent deployment
</span>
<span class="boring"> Fails if directory already exists
</span>mkdir /app/releases/v1.0.0

<span class="boring"> Fails if file already deleted
</span>rm /app/old-config.txt

<span class="boring"> Creates duplicate symlink or fails
</span>ln -s /app/releases/v1.0.0 /app/current

<span class="boring"> Appends duplicate entries
</span>echo "export PATH=/app/bin:$PATH" &gt;&gt; ~/.bashrc
</code></pre>
<p><strong>Problems</strong>:</p>
<ul>
<li><code>mkdir /app/releases/v1.0.0</code> → <strong>ERROR</strong>: "File exists" (fails on 2nd run)</li>
<li><code>rm /app/old-config.txt</code> → <strong>ERROR</strong>: "No such file" (fails if already deleted)</li>
<li><code>ln -s ...</code> → <strong>ERROR</strong>: "File exists" (fails if link exists)</li>
<li><code>echo ... &gt;&gt; ~/.bashrc</code> → Appends duplicate entries every run</li>
</ul>
<p><strong>Impact</strong>:</p>
<ul>
<li>❌ Can't re-run deployments (fail on retry)</li>
<li>❌ Can't recover from failures (script breaks halfway)</li>
<li>❌ Can't repeat operations (inconsistent state)</li>
<li>❌ Manual cleanup required (error-prone)</li>
</ul>
<h3 id="the-solution-idempotent-scripts"><a class="header" href="#the-solution-idempotent-scripts">The Solution: Idempotent Scripts</a></h3>
<p>Idempotent scripts are safe to re-run without errors:</p>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Idempotent deployment
</span>
<span class="boring"> Safe: creates directory if missing, succeeds if exists
</span>mkdir -p /app/releases/v1.0.0

<span class="boring"> Safe: removes file if exists, succeeds if missing
</span>rm -f /app/old-config.txt

<span class="boring"> Safe: remove old link, create new one
</span>rm -f /app/current
ln -s /app/releases/v1.0.0 /app/current

<span class="boring"> Safe: only add if not already present
</span>grep -q "export PATH=/app/bin" ~/.bashrc || \
    echo "export PATH=/app/bin:\$PATH" &gt;&gt; ~/.bashrc
</code></pre>
<p><strong>Benefits</strong>:</p>
<ul>
<li>✅ Safe to re-run: No errors on 2nd, 3rd, Nth execution</li>
<li>✅ Recoverable: Can retry after failures</li>
<li>✅ Predictable: Always reaches same final state</li>
<li>✅ Automated: No manual intervention needed</li>
</ul>
<h2 id="sources-of-non-idempotency"><a class="header" href="#sources-of-non-idempotency">Sources of Non-Idempotency</a></h2>
<p>Rash detects and eliminates these common patterns:</p>
<h3 id="1-mkdir-without--p-idem001"><a class="header" href="#1-mkdir-without--p-idem001">1. mkdir without -p (IDEM001)</a></h3>
<p><strong>Problem</strong>: Fails if directory exists</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>mkdir /app/releases/v1.0.0
<span class="boring"> First run: ✅ Success
</span><span class="boring"> Second run: ❌ mkdir: cannot create directory '/app/releases/v1.0.0': File exists
</span></code></pre>
<p><strong>Solution</strong>: Always use <code>-p</code> flag</p>
<pre><code class="language-bash"><span class="boring"> Idempotent
</span>mkdir -p /app/releases/v1.0.0
<span class="boring"> First run: ✅ Creates directory
</span><span class="boring"> Second run: ✅ Directory exists (no error)
</span><span class="boring"> Nth run: ✅ Always succeeds
</span></code></pre>
<h3 id="2-rm-without--f-idem002"><a class="header" href="#2-rm-without--f-idem002">2. rm without -f (IDEM002)</a></h3>
<p><strong>Problem</strong>: Fails if file doesn't exist</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>rm /app/old-config.txt
<span class="boring"> First run: ✅ File deleted
</span><span class="boring"> Second run: ❌ rm: cannot remove '/app/old-config.txt': No such file or directory
</span></code></pre>
<p><strong>Solution</strong>: Always use <code>-f</code> flag</p>
<pre><code class="language-bash"><span class="boring"> Idempotent
</span>rm -f /app/old-config.txt
<span class="boring"> First run: ✅ File deleted
</span><span class="boring"> Second run: ✅ File already gone (no error)
</span><span class="boring"> Nth run: ✅ Always succeeds
</span></code></pre>
<h3 id="3-ln--s-without-cleanup-idem003"><a class="header" href="#3-ln--s-without-cleanup-idem003">3. ln -s without cleanup (IDEM003)</a></h3>
<p><strong>Problem</strong>: Fails if symlink exists</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>ln -s /app/releases/v1.0.0 /app/current
<span class="boring"> First run: ✅ Symlink created
</span><span class="boring"> Second run: ❌ ln: failed to create symbolic link '/app/current': File exists
</span></code></pre>
<p><strong>Solution</strong>: Remove old link first</p>
<pre><code class="language-bash"><span class="boring"> Idempotent
</span>rm -f /app/current
ln -s /app/releases/v1.0.0 /app/current
<span class="boring"> First run: ✅ Creates symlink
</span><span class="boring"> Second run: ✅ Replaces symlink
</span><span class="boring"> Nth run: ✅ Always succeeds
</span></code></pre>
<h3 id="4-appending-to-files-idem004"><a class="header" href="#4-appending-to-files-idem004">4. Appending to files (IDEM004)</a></h3>
<p><strong>Problem</strong>: Creates duplicate entries</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>echo "export PATH=/app/bin:\$PATH" &gt;&gt; ~/.bashrc
<span class="boring"> First run: Adds line (correct)
</span><span class="boring"> Second run: Adds duplicate line
</span><span class="boring"> Nth run: N duplicate lines (wrong!)
</span></code></pre>
<p><strong>Solution</strong>: Check before appending</p>
<pre><code class="language-bash"><span class="boring"> Idempotent
</span>grep -q "export PATH=/app/bin" ~/.bashrc || \
    echo "export PATH=/app/bin:\$PATH" &gt;&gt; ~/.bashrc
<span class="boring"> First run: ✅ Adds line
</span><span class="boring"> Second run: ✅ Line exists (skips)
</span><span class="boring"> Nth run: ✅ Always one line
</span></code></pre>
<h3 id="5-creating-files-with--idem005"><a class="header" href="#5-creating-files-with--idem005">5. Creating files with &gt; (IDEM005)</a></h3>
<p><strong>Problem</strong>: Not idempotent if file must not exist</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent (if uniqueness required)
</span>echo "config=value" &gt; /etc/myapp/config.conf
<span class="boring"> Creates new file each time (might overwrite important data)
</span></code></pre>
<p><strong>Solution</strong>: Use conditional creation or explicit overwrite</p>
<pre><code class="language-bash"><span class="boring"> Idempotent (explicit overwrite intended)
</span>mkdir -p /etc/myapp
echo "config=value" &gt; /etc/myapp/config.conf
<span class="boring"> Always writes same config (idempotent for config management)
</span>
<span class="boring"> Or conditional creation
</span>if [ ! -f /etc/myapp/config.conf ]; then
    echo "config=value" &gt; /etc/myapp/config.conf
fi
</code></pre>
<h3 id="6-database-inserts-idem006"><a class="header" href="#6-database-inserts-idem006">6. Database inserts (IDEM006)</a></h3>
<p><strong>Problem</strong>: Duplicate records</p>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>psql -c "INSERT INTO users (name) VALUES ('admin')"
<span class="boring"> First run: Creates user
</span><span class="boring"> Second run: Creates duplicate user (or fails with constraint violation)
</span></code></pre>
<p><strong>Solution</strong>: Use INSERT ... ON CONFLICT or upserts</p>
<pre><code class="language-bash"><span class="boring"> Idempotent
</span>psql -c "INSERT INTO users (name) VALUES ('admin') ON CONFLICT (name) DO NOTHING"
<span class="boring"> First run: Creates user
</span><span class="boring"> Second run: User exists (no duplicate)
</span><span class="boring"> Nth run: Always one user
</span></code></pre>
<h2 id="testing-idempotency"><a class="header" href="#testing-idempotency">Testing Idempotency</a></h2>
<h3 id="property-test-multiple-runs--same-state"><a class="header" href="#property-test-multiple-runs--same-state">Property Test: Multiple Runs → Same State</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Test: Run script 3 times, verify same final state
</span>
<span class="boring"> Clean state
</span>rm -rf /tmp/test_deploy

<span class="boring"> Run 1
</span>sh deploy.sh v1.0.0 2&gt;&amp;1 | tee run1.log
state1=$(ls -la /tmp/test_deploy)

<span class="boring"> Run 2
</span>sh deploy.sh v1.0.0 2&gt;&amp;1 | tee run2.log
state2=$(ls -la /tmp/test_deploy)

<span class="boring"> Run 3
</span>sh deploy.sh v1.0.0 2&gt;&amp;1 | tee run3.log
state3=$(ls -la /tmp/test_deploy)

<span class="boring"> Verify identical state
</span>if [ "$state1" = "$state2" ] &amp;&amp; [ "$state2" = "$state3" ]; then
    echo "PASS: All runs produced same state (idempotent ✅)"
else
    echo "FAIL: State differs between runs (not idempotent)"
    exit 1
fi
</code></pre>
<h3 id="property-test-no-errors-on-re-run"><a class="header" href="#property-test-no-errors-on-re-run">Property Test: No Errors on Re-Run</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Test: Run script twice, verify both succeed
</span>
<span class="boring"> Run 1
</span>sh deploy.sh v1.0.0
exit_code1=$?

<span class="boring"> Run 2 (should not fail)
</span>sh deploy.sh v1.0.0
exit_code2=$?

if [ $exit_code1 -eq 0 ] &amp;&amp; [ $exit_code2 -eq 0 ]; then
    echo "PASS: Both runs succeeded (idempotent ✅)"
else
    echo "FAIL: Run 1: $exit_code1, Run 2: $exit_code2 (not idempotent)"
    exit 1
fi
</code></pre>
<h3 id="repeatability-test"><a class="header" href="#repeatability-test">Repeatability Test</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Test: Run script 100 times, verify all succeed
</span>
for i in $(seq 1 100); do
    sh deploy.sh v1.0.0 &gt; /dev/null 2&gt;&amp;1
    if [ $? -ne 0 ]; then
        echo "FAIL: Run $i failed (not idempotent)"
        exit 1
    fi
done

echo "PASS: All 100 runs succeeded (idempotent ✅)"
</code></pre>
<h2 id="linter-detection"><a class="header" href="#linter-detection">Linter Detection</a></h2>
<p>Rash linter detects non-idempotent patterns:</p>
<pre><code class="language-bash">bashrs lint deploy.sh
</code></pre>
<p>Output:</p>
<pre><code class="language-text">deploy.sh:3:1: IDEM001 [Error] Non-idempotent: mkdir without -p flag
deploy.sh:4:1: IDEM002 [Error] Non-idempotent: rm without -f flag
deploy.sh:5:1: IDEM003 [Error] Non-idempotent: ln -s without cleanup
deploy.sh:6:1: IDEM004 [Error] Non-idempotent: append without duplicate check
</code></pre>
<h2 id="purification-transforms"><a class="header" href="#purification-transforms">Purification Transforms</a></h2>
<p>Rash purification automatically fixes idempotency issues:</p>
<h3 id="before-non-idempotent"><a class="header" href="#before-non-idempotent">Before: Non-Idempotent</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/bash
</span><span class="boring"> Non-idempotent deployment
</span>
mkdir /app/releases/v1.0.0
mkdir /app/logs
rm /app/old-config.txt
ln -s /app/releases/v1.0.0 /app/current
echo "export PATH=/app/bin:\$PATH" &gt;&gt; ~/.bashrc
</code></pre>
<h3 id="after-idempotent"><a class="header" href="#after-idempotent">After: Idempotent</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Purified by Rash v6.30.1
</span>
deploy() {
    _version="${1}"

<span class="boring">     Idempotent: mkdir -p (safe to re-run)
</span>    mkdir -p "/app/releases/${_version}"
    mkdir -p "/app/logs"

<span class="boring">     Idempotent: rm -f (safe if file missing)
</span>    rm -f "/app/old-config.txt"

<span class="boring">     Idempotent: remove old link, create new
</span>    rm -f "/app/current"
    ln -s "/app/releases/${_version}" "/app/current"

<span class="boring">     Idempotent: conditional append
</span>    grep -q "export PATH=/app/bin" ~/.bashrc || \
        echo "export PATH=/app/bin:\$PATH" &gt;&gt; ~/.bashrc
}

deploy "${1}"
</code></pre>
<p><strong>Transformations</strong>:</p>
<ul>
<li>✅ <code>mkdir</code> → <code>mkdir -p</code> (idempotent)</li>
<li>✅ <code>rm</code> → <code>rm -f</code> (idempotent)</li>
<li>✅ <code>ln -s</code> → <code>rm -f &amp;&amp; ln -s</code> (idempotent)</li>
<li>✅ <code>echo &gt;&gt;</code> → <code>grep -q || echo &gt;&gt;</code> (idempotent)</li>
</ul>
<h2 id="best-practices"><a class="header" href="#best-practices">Best Practices</a></h2>
<h3 id="1-always-use--p-for-mkdir"><a class="header" href="#1-always-use--p-for-mkdir">1. Always Use -p for mkdir</a></h3>
<pre><code class="language-bash"><span class="boring"> ❌ BAD: Fails if exists
</span>mkdir /app/config

<span class="boring"> ✅ GOOD: Always succeeds
</span>mkdir -p /app/config
</code></pre>
<h3 id="2-always-use--f-for-rm"><a class="header" href="#2-always-use--f-for-rm">2. Always Use -f for rm</a></h3>
<pre><code class="language-bash"><span class="boring"> ❌ BAD: Fails if missing
</span>rm /tmp/old-file.txt

<span class="boring"> ✅ GOOD: Always succeeds
</span>rm -f /tmp/old-file.txt
</code></pre>
<h3 id="3-clean-before-creating-symlinks"><a class="header" href="#3-clean-before-creating-symlinks">3. Clean Before Creating Symlinks</a></h3>
<pre><code class="language-bash"><span class="boring"> ❌ BAD: Fails if exists
</span>ln -s /app/new /app/link

<span class="boring"> ✅ GOOD: Remove old, create new
</span>rm -f /app/link
ln -s /app/new /app/link
</code></pre>
<h3 id="4-check-before-appending"><a class="header" href="#4-check-before-appending">4. Check Before Appending</a></h3>
<pre><code class="language-bash"><span class="boring"> ❌ BAD: Creates duplicates
</span>echo "line" &gt;&gt; file.txt

<span class="boring"> ✅ GOOD: Add only if missing
</span>grep -q "line" file.txt || echo "line" &gt;&gt; file.txt
</code></pre>
<h3 id="5-use-conditional-file-creation"><a class="header" href="#5-use-conditional-file-creation">5. Use Conditional File Creation</a></h3>
<pre><code class="language-bash"><span class="boring"> ❌ BAD: Blindly overwrites
</span>echo "data" &gt; /etc/config.txt

<span class="boring"> ✅ GOOD: Create only if missing
</span>if [ ! -f /etc/config.txt ]; then
    echo "data" &gt; /etc/config.txt
fi

<span class="boring"> Or explicit overwrite (if idempotent config management)
</span>echo "data" &gt; /etc/config.txt  # Idempotent for config files
</code></pre>
<h2 id="common-patterns"><a class="header" href="#common-patterns">Common Patterns</a></h2>
<h3 id="pattern-1-idempotent-directory-setup"><a class="header" href="#pattern-1-idempotent-directory-setup">Pattern 1: Idempotent Directory Setup</a></h3>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>mkdir /app
mkdir /app/bin
mkdir /app/config

<span class="boring"> Idempotent
</span>mkdir -p /app/bin /app/config
</code></pre>
<h3 id="pattern-2-idempotent-cleanup"><a class="header" href="#pattern-2-idempotent-cleanup">Pattern 2: Idempotent Cleanup</a></h3>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>rm /tmp/*.log

<span class="boring"> Idempotent
</span>rm -f /tmp/*.log
</code></pre>
<h3 id="pattern-3-idempotent-configuration"><a class="header" href="#pattern-3-idempotent-configuration">Pattern 3: Idempotent Configuration</a></h3>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>echo "setting=value" &gt;&gt; /etc/config.conf

<span class="boring"> Idempotent
</span>config_file="/etc/config.conf"
grep -q "setting=value" "$config_file" || \
    echo "setting=value" &gt;&gt; "$config_file"
</code></pre>
<h3 id="pattern-4-idempotent-service-management"><a class="header" href="#pattern-4-idempotent-service-management">Pattern 4: Idempotent Service Management</a></h3>
<pre><code class="language-bash"><span class="boring"> Non-idempotent
</span>systemctl start myservice

<span class="boring"> Idempotent
</span>systemctl is-active myservice || systemctl start myservice

<span class="boring"> Or simpler (systemctl start is already idempotent)
</span>systemctl start myservice  # Safe to re-run
</code></pre>
<h2 id="integration-with-determinism"><a class="header" href="#integration-with-determinism">Integration with Determinism</a></h2>
<p>Idempotency and determinism work together:</p>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Both deterministic AND idempotent
</span>
deploy() {
    version="${1}"  # Deterministic: same input always

<span class="boring">     Idempotent: safe to re-run
</span>    mkdir -p "/app/releases/${version}"
    rm -f "/app/current"
    ln -s "/app/releases/${version}" "/app/current"

    echo "Deployed ${version}"  # Deterministic output
}

deploy "${1}"
</code></pre>
<p><strong>Properties</strong>:</p>
<ul>
<li>✅ Deterministic: Same version always produces same output</li>
<li>✅ Idempotent: Running twice with same version is safe</li>
</ul>
<p><strong>Testing Both Properties</strong>:</p>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Test determinism + idempotency
</span>
<span class="boring"> Test 1: Determinism (same input → same output)
</span>sh deploy.sh v1.0.0 &gt; output1.txt
sh deploy.sh v1.0.0 &gt; output2.txt
diff output1.txt output2.txt
<span class="boring"> Expected: Identical (deterministic ✅)
</span>
<span class="boring"> Test 2: Idempotency (multiple runs → same state)
</span>sh deploy.sh v1.0.0
state1=$(ls -la /app)
sh deploy.sh v1.0.0
state2=$(ls -la /app)
[ "$state1" = "$state2" ]
<span class="boring"> Expected: Same state (idempotent ✅)
</span></code></pre>
<h2 id="advanced-patterns"><a class="header" href="#advanced-patterns">Advanced Patterns</a></h2>
<h3 id="atomic-operations"><a class="header" href="#atomic-operations">Atomic Operations</a></h3>
<p>Some operations are naturally atomic and idempotent:</p>
<pre><code class="language-bash"><span class="boring"> Idempotent: Overwriting files
</span>cp /source/config.txt /dest/config.txt
<span class="boring"> Run 1: Copies file
</span><span class="boring"> Run N: Overwrites with same content (idempotent)
</span>
<span class="boring"> Idempotent: Setting environment
</span>export PATH="/app/bin:$PATH"
<span class="boring"> Run N: Same PATH value (idempotent)
</span>
<span class="boring"> Idempotent: Kill processes
</span>killall -q myprocess || true
<span class="boring"> Run N: Process killed or already dead (idempotent)
</span></code></pre>
<h3 id="database-migrations"><a class="header" href="#database-migrations">Database Migrations</a></h3>
<pre><code class="language-bash"><span class="boring"> Idempotent: Schema migrations
</span>psql -c "CREATE TABLE IF NOT EXISTS users (id SERIAL, name TEXT)"
<span class="boring"> Run N: Table exists or created (idempotent)
</span>
<span class="boring"> Idempotent: Upserts
</span>psql -c "INSERT INTO settings (key, value) VALUES ('timeout', '30') \
         ON CONFLICT (key) DO UPDATE SET value = EXCLUDED.value"
<span class="boring"> Run N: Setting updated (idempotent)
</span></code></pre>
<h3 id="container-initialization"><a class="header" href="#container-initialization">Container Initialization</a></h3>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Idempotent container init script
</span>
<span class="boring"> Idempotent: Directory structure
</span>mkdir -p /data/logs /data/config /data/cache

<span class="boring"> Idempotent: Default config (only if missing)
</span>if [ ! -f /data/config/app.conf ]; then
    cp /defaults/app.conf /data/config/app.conf
fi

<span class="boring"> Idempotent: Permissions
</span>chown -R app:app /data

<span class="boring"> Idempotent: Service start (systemd handles idempotency)
</span>exec /app/bin/myservice
</code></pre>
<h2 id="verification-checklist"><a class="header" href="#verification-checklist">Verification Checklist</a></h2>
<p>Before marking a script as idempotent, verify:</p>
<ul>
<li><input disabled="" type="checkbox"/>
✅ <strong>mkdir has -p flag</strong>: All directory creation is idempotent</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>rm has -f flag</strong>: All file removal is idempotent</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>Symlinks cleaned</strong>: Old links removed before creating new ones</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>No duplicate appends</strong>: Appends check for existing content</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>Multiple runs succeed</strong>: Script runs 100+ times without errors</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>Same final state</strong>: All runs produce identical final state</li>
<li><input disabled="" type="checkbox"/>
✅ <strong>No side effects</strong>: No accumulating files, processes, or data</li>
</ul>
<h2 id="error-handling-for-idempotency"><a class="header" href="#error-handling-for-idempotency">Error Handling for Idempotency</a></h2>
<pre><code class="language-bash"><span class="boring">!/bin/sh
</span><span class="boring"> Idempotent error handling
</span>
deploy() {
    version="${1}"

<span class="boring">     Idempotent: Create or verify directory exists
</span>    mkdir -p "/app/releases/${version}" || {
        echo "ERROR: Cannot create release directory"
        return 1
    }

<span class="boring">     Idempotent: Remove old link (ignore errors if not exists)
</span>    rm -f "/app/current"

<span class="boring">     Idempotent: Create new link
</span>    ln -s "/app/releases/${version}" "/app/current" || {
        echo "ERROR: Cannot create symlink"
        return 1
    }

    echo "Deployed ${version} successfully"
}
</code></pre>
<h2 id="further-reading"><a class="header" href="#further-reading">Further Reading</a></h2>
<ul>
<li><a href="./purification.html">Purification Overview</a> - Complete purification process</li>
<li><a href="./determinism.html">Determinism Concept</a> - Predictable script behavior</li>
<li><a href="./posix.html">POSIX Compliance</a> - Portable shell scripts</li>
<li><a href="../linting/idempotency.html">IDEM Rules</a> - Linter rules for idempotency</li>
</ul>
<hr />
<p><strong>Key Takeaway</strong>: Idempotency makes scripts safe to re-run. Always use <code>-p</code> for mkdir, <code>-f</code> for rm, cleanup before creating symlinks, and check before appending to files.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../concepts/determinism.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../concepts/posix.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../concepts/determinism.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../concepts/posix.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
