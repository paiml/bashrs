# bashrs purify --with-tests Feature Specification

**Status**: üî¥ DRAFT - Phase 0
**Created**: 2025-11-03
**Methodology**: EXTREME TDD
**Target Coverage**: >80%
**Target Kill Rate**: ‚â•90% mutation testing

---

## Executive Summary

The `bashrs purify --with-tests` flag generates comprehensive test suites for purified bash scripts, ensuring:
- **Correctness**: Purified script behaves identically to original
- **Determinism**: Same inputs always produce same outputs
- **Idempotency**: Safe to re-run multiple times
- **POSIX Compliance**: Generated tests pass shellcheck

---

## Use Cases

### UC-001: Generate Tests for Deployment Script
```bash
# Input: messy_deploy.sh (with $RANDOM, timestamps, non-idempotent ops)
$ bashrs purify messy_deploy.sh --with-tests -o deploy.sh

# Output:
# - deploy.sh (purified script)
# - deploy_test.sh (comprehensive test suite)
```

**Generated Test Suite**:
```bash
#!/bin/sh
# Tests for deploy.sh
# Generated by bashrs purify --with-tests

# Test 1: Determinism - Same inputs produce same outputs
test_determinism() {
    result1=$(./deploy.sh --version 1.0.0)
    result2=$(./deploy.sh --version 1.0.0)
    [ "$result1" = "$result2" ] || { echo "FAIL: Non-deterministic"; exit 1; }
    echo "PASS: Determinism"
}

# Test 2: Idempotency - Safe to re-run
test_idempotency() {
    ./deploy.sh --version 1.0.0
    ./deploy.sh --version 1.0.0  # Should not fail
    echo "PASS: Idempotency"
}

# Test 3: POSIX Compliance
test_posix_compliance() {
    shellcheck -s sh deploy.sh || { echo "FAIL: Not POSIX"; exit 1; }
    echo "PASS: POSIX"
}

# Run all tests
test_determinism
test_idempotency
test_posix_compliance

echo "All tests passed!"
```

### UC-002: Generate Tests for CI/CD Pipeline
```bash
# Integration with CI/CD
$ bashrs purify scripts/*.sh --with-tests --output-dir purified/

# Generated:
# purified/build.sh + purified/build_test.sh
# purified/deploy.sh + purified/deploy_test.sh
# purified/rollback.sh + purified/rollback_test.sh

# CI runs:
$ cd purified && ./build_test.sh && ./deploy_test.sh && ./rollback_test.sh
```

### UC-003: Property-Based Testing
```bash
# Generate property tests with fuzzing
$ bashrs purify config_parser.sh --with-tests --property-tests

# Output: config_parser_test.sh includes:
# - Determinism properties (100+ test cases)
# - Idempotency properties (100+ test cases)
# - Input validation properties
```

---

## Feature Requirements

### FR-001: Test Generation (MANDATORY)
**Priority**: P0
**Description**: Generate POSIX-compliant test scripts for purified bash.

**Requirements**:
- ‚úÖ Generate test file: `<script>_test.sh`
- ‚úÖ Include shebang: `#!/bin/sh`
- ‚úÖ Test determinism (same inputs ‚Üí same outputs)
- ‚úÖ Test idempotency (safe to re-run)
- ‚úÖ Test POSIX compliance (shellcheck passes)
- ‚úÖ Exit 0 on success, non-zero on failure
- ‚úÖ Print test results to stdout

**Test Coverage Target**: >80% of purified script lines

### FR-002: Determinism Tests (MANDATORY)
**Priority**: P0
**Description**: Verify purified scripts produce deterministic outputs.

**Test Cases**:
```bash
# Test: Run script twice with same inputs
test_determinism() {
    output1=$(./script.sh arg1 arg2)
    output2=$(./script.sh arg1 arg2)

    if [ "$output1" = "$output2" ]; then
        echo "PASS: Determinism"
        return 0
    else
        echo "FAIL: Non-deterministic outputs"
        echo "  Run 1: $output1"
        echo "  Run 2: $output2"
        return 1
    fi
}
```

**Property Tests** (if --property-tests enabled):
- Generate 100+ random input combinations
- Verify each input produces consistent output across runs

### FR-003: Idempotency Tests (MANDATORY)
**Priority**: P0
**Description**: Verify scripts are safe to re-run.

**Test Cases**:
```bash
# Test: mkdir -p should not fail on re-run
test_idempotent_mkdir() {
    ./script.sh create-dirs
    ./script.sh create-dirs  # Should succeed
    echo "PASS: Idempotent mkdir"
}

# Test: rm -f should not fail on missing files
test_idempotent_rm() {
    ./script.sh cleanup
    ./script.sh cleanup  # Should succeed
    echo "PASS: Idempotent rm"
}
```

### FR-004: POSIX Compliance Tests (MANDATORY)
**Priority**: P0
**Description**: Ensure generated tests and purified scripts are POSIX-compliant.

**Test Cases**:
```bash
# Test: shellcheck validation
test_posix_compliance() {
    if command -v shellcheck >/dev/null 2>&1; then
        shellcheck -s sh ./script.sh || {
            echo "FAIL: shellcheck found issues"
            return 1
        }
    else
        echo "SKIP: shellcheck not installed"
        return 0
    fi
    echo "PASS: POSIX compliance"
}
```

### FR-005: Property-Based Testing (OPTIONAL)
**Priority**: P1
**Description**: Generate property tests with fuzzing support.

**Flag**: `--property-tests`

**Generated Tests**:
```bash
# Property: Determinism holds for all inputs
test_property_determinism() {
    # Generate 100 random test cases
    for i in $(seq 1 100); do
        input="test_input_$i"
        output1=$(./script.sh "$input")
        output2=$(./script.sh "$input")

        [ "$output1" = "$output2" ] || {
            echo "FAIL: Determinism violated for input: $input"
            return 1
        }
    done
    echo "PASS: Determinism property (100 cases)"
}
```

### FR-006: Test Execution Report (OPTIONAL)
**Priority**: P2
**Description**: Generate JSON test execution reports.

**Flag**: `--test-report <file>`

**Output**: `test_report.json`
```json
{
  "script": "deploy.sh",
  "timestamp": "2025-11-03T14:30:00Z",
  "tests": [
    {
      "name": "test_determinism",
      "status": "passed",
      "duration_ms": 120
    },
    {
      "name": "test_idempotency",
      "status": "passed",
      "duration_ms": 85
    },
    {
      "name": "test_posix_compliance",
      "status": "passed",
      "duration_ms": 450
    }
  ],
  "summary": {
    "total": 3,
    "passed": 3,
    "failed": 0,
    "skipped": 0,
    "coverage_percent": 92.5
  }
}
```

---

## Implementation Plan (EXTREME TDD)

### Phase 1: RED (Failing Tests)
**Goal**: Write failing CLI tests for `--with-tests` flag

**Tasks**:
1. ‚úÖ Create `rash/tests/cli_purify_with_tests.rs`
2. ‚úÖ Write test: `test_WITH_TESTS_001_generates_test_file`
3. ‚úÖ Write test: `test_WITH_TESTS_002_determinism_test`
4. ‚úÖ Write test: `test_WITH_TESTS_003_idempotency_test`
5. ‚úÖ Write test: `test_WITH_TESTS_004_posix_compliance_test`
6. ‚úÖ Run: `cargo test cli_purify_with_tests` ‚Üí **FAILS** ‚ùå

**Expected**: All tests fail (flag not implemented yet)

### Phase 2: GREEN (Make Tests Pass)
**Goal**: Implement minimal `--with-tests` functionality

**Tasks**:
1. ‚úÖ Add `--with-tests` flag to CLI (`rash/src/cli/commands/purify.rs`)
2. ‚úÖ Create `TestGenerator` module (`rash/src/bash_transpiler/test_generator.rs`)
3. ‚úÖ Implement test generation:
   - `generate_determinism_test()`
   - `generate_idempotency_test()`
   - `generate_posix_compliance_test()`
4. ‚úÖ Write generated tests to `<script>_test.sh`
5. ‚úÖ Run: `cargo test cli_purify_with_tests` ‚Üí **PASSES** ‚úÖ

**Expected**: All CLI tests pass

### Phase 3: REFACTOR (Clean Up)
**Goal**: Improve code quality and maintainability

**Tasks**:
1. ‚úÖ Extract test templates to separate module
2. ‚úÖ Add comprehensive error handling
3. ‚úÖ Ensure code complexity <10
4. ‚úÖ Run: `cargo clippy` ‚Üí **PASSES** ‚úÖ

### Phase 4: PROPERTY TESTING (Quality Assurance)
**Goal**: Verify test generation with property tests

**Tasks**:
1. ‚úÖ Create `rash/src/bash_transpiler/test_generator_property_tests.rs`
2. ‚úÖ Property: Generated tests are valid POSIX sh
3. ‚úÖ Property: Generated tests are executable
4. ‚úÖ Property: Test generation is deterministic
5. ‚úÖ Run: `cargo test test_generator_property_tests` ‚Üí **PASSES** ‚úÖ

**Expected**: 100+ property test cases pass

### Phase 5: MUTATION TESTING (Kill Rate Verification)
**Goal**: Verify test effectiveness with mutation testing

**Tasks**:
1. ‚úÖ Run: `cargo mutants --file rash/src/bash_transpiler/test_generator.rs`
2. ‚úÖ Target: ‚â•90% kill rate
3. ‚úÖ If <90%: Add targeted tests for MISSED mutants
4. ‚úÖ Re-run until ‚â•90% achieved

**Expected**: Mutation kill rate ‚â•90%

### Phase 6: COVERAGE ANALYSIS (80%+ Target)
**Goal**: Verify code coverage meets >80% threshold

**Tasks**:
1. ‚úÖ Run: `cargo llvm-cov --lib --html`
2. ‚úÖ Verify: Test generator module >80% coverage
3. ‚úÖ Verify: CLI integration >80% coverage
4. ‚úÖ If <80%: Add missing tests

**Expected**: Coverage >80%

---

## CLI Interface

### Basic Usage
```bash
# Generate tests alongside purified script
$ bashrs purify deploy.sh --with-tests -o deploy_purified.sh

# Output:
# - deploy_purified.sh (purified script)
# - deploy_purified_test.sh (test suite)
```

### Advanced Usage
```bash
# Generate property tests
$ bashrs purify deploy.sh --with-tests --property-tests

# Generate test report
$ bashrs purify deploy.sh --with-tests --test-report report.json

# Custom test output location
$ bashrs purify deploy.sh --with-tests --test-output deploy.test.sh
```

### Flag Specifications

| Flag | Type | Default | Description |
|------|------|---------|-------------|
| `--with-tests` | bool | false | Generate test suite for purified script |
| `--property-tests` | bool | false | Generate property-based tests (100+ cases) |
| `--test-output <file>` | string | `<script>_test.sh` | Custom test file path |
| `--test-report <file>` | string | None | Generate JSON test execution report |

---

## Quality Gates (MANDATORY)

Before merging, ALL gates must pass:

### Gate 1: CLI Tests (RED ‚Üí GREEN)
```bash
cargo test cli_purify_with_tests
# Expected: 100% pass rate
```

### Gate 2: Property Tests
```bash
cargo test test_generator_property_tests
# Expected: 100% pass rate (1000+ generated cases)
```

### Gate 3: Mutation Testing
```bash
cargo mutants --file rash/src/bash_transpiler/test_generator.rs
# Expected: ‚â•90% kill rate
```

### Gate 4: Code Coverage
```bash
cargo llvm-cov --lib
# Expected: >80% coverage on test_generator module
```

### Gate 5: Clippy
```bash
cargo clippy --all-targets -- -D warnings
# Expected: Zero warnings
```

### Gate 6: Integration Test
```bash
# Real-world validation
bashrs purify examples/deploy.sh --with-tests -o /tmp/deploy.sh
/tmp/deploy_test.sh  # Run generated tests
# Expected: All tests pass
```

---

## Test Coverage Matrix

| Module | Unit Tests | Property Tests | Mutation Coverage | Line Coverage |
|--------|-----------|----------------|-------------------|---------------|
| `test_generator.rs` | ‚úÖ Required | ‚úÖ Required | ‚â•90% | >80% |
| `cli/commands/purify.rs` | ‚úÖ Required | ‚ö†Ô∏è Optional | ‚â•85% | >75% |
| `bash_transpiler/mod.rs` | ‚úÖ Existing | ‚úÖ Existing | ‚â•85% | >85% |

---

## Example: Generated Test Suite

**Input**: `deploy.sh` (messy bash with $RANDOM, timestamps)

**Command**:
```bash
bashrs purify deploy.sh --with-tests --property-tests
```

**Output**: `deploy_test.sh`
```bash
#!/bin/sh
# Test Suite for deploy.sh
# Generated by bashrs purify --with-tests
# Date: 2025-11-03T14:30:00Z

set -e  # Exit on first failure

# Test 1: Determinism - Same inputs produce same outputs
test_determinism() {
    echo "Testing: Determinism..."

    # Run script twice with same inputs
    output1=$(./deploy.sh --version 1.0.0 --env prod)
    output2=$(./deploy.sh --version 1.0.0 --env prod)

    if [ "$output1" = "$output2" ]; then
        echo "  ‚úÖ PASS: Outputs are identical"
        return 0
    else
        echo "  ‚ùå FAIL: Outputs differ"
        echo "    Run 1: $output1"
        echo "    Run 2: $output2"
        return 1
    fi
}

# Test 2: Idempotency - Safe to re-run
test_idempotency() {
    echo "Testing: Idempotency..."

    # First run
    ./deploy.sh --version 1.0.0 --env staging || {
        echo "  ‚ùå FAIL: First run failed"
        return 1
    }

    # Second run (should not fail)
    ./deploy.sh --version 1.0.0 --env staging || {
        echo "  ‚ùå FAIL: Second run failed (not idempotent)"
        return 1
    }

    echo "  ‚úÖ PASS: Script is idempotent"
    return 0
}

# Test 3: POSIX Compliance
test_posix_compliance() {
    echo "Testing: POSIX Compliance..."

    if command -v shellcheck >/dev/null 2>&1; then
        shellcheck -s sh ./deploy.sh || {
            echo "  ‚ùå FAIL: shellcheck found POSIX violations"
            return 1
        }
        echo "  ‚úÖ PASS: POSIX compliant (shellcheck)"
    else
        echo "  ‚ö†Ô∏è  SKIP: shellcheck not installed"
    fi
    return 0
}

# Property Test 4: Determinism holds for all inputs (100 cases)
test_property_determinism() {
    echo "Testing: Determinism Property (100 cases)..."

    passed=0
    failed=0

    for i in $(seq 1 100); do
        version="1.0.$i"
        output1=$(./deploy.sh --version "$version" --env test)
        output2=$(./deploy.sh --version "$version" --env test)

        if [ "$output1" = "$output2" ]; then
            passed=$((passed + 1))
        else
            failed=$((failed + 1))
            echo "    ‚ùå Case $i failed (version=$version)"
        fi
    done

    if [ $failed -eq 0 ]; then
        echo "  ‚úÖ PASS: Determinism property ($passed/100 cases)"
        return 0
    else
        echo "  ‚ùå FAIL: $failed/100 cases failed"
        return 1
    fi
}

# Test Runner
echo "================================================"
echo "bashrs purify --with-tests"
echo "Script: deploy.sh"
echo "Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo "================================================"
echo ""

# Run all tests
failed_tests=""

test_determinism || failed_tests="$failed_tests test_determinism"
test_idempotency || failed_tests="$failed_tests test_idempotency"
test_posix_compliance || failed_tests="$failed_tests test_posix_compliance"
test_property_determinism || failed_tests="$failed_tests test_property_determinism"

echo ""
echo "================================================"

if [ -z "$failed_tests" ]; then
    echo "‚úÖ All tests passed!"
    exit 0
else
    echo "‚ùå Failed tests:$failed_tests"
    exit 1
fi
```

---

## Success Metrics

| Metric | Target | Validation |
|--------|--------|------------|
| **Test Coverage** | >80% | `cargo llvm-cov --lib` |
| **Mutation Kill Rate** | ‚â•90% | `cargo mutants` |
| **Clippy Warnings** | 0 | `cargo clippy` |
| **CLI Tests** | 100% pass | `cargo test cli_purify_with_tests` |
| **Property Tests** | 100% pass | `cargo test test_generator_property_tests` |
| **Integration Tests** | 100% pass | Real-world script testing |

---

## Risks and Mitigations

### Risk 1: Generated Tests May Be Too Broad
**Mitigation**: Start with minimal determinism + idempotency tests, expand later

### Risk 2: Property Tests May Be Slow
**Mitigation**: Make property tests optional (--property-tests flag)

### Risk 3: Coverage May Drop Below 80%
**Mitigation**: Add targeted unit tests for edge cases

---

## Next Steps

1. ‚úÖ **Review Spec**: Validate with team
2. ‚è≥ **Phase 1 (RED)**: Write failing CLI tests
3. ‚è≥ **Phase 2 (GREEN)**: Implement feature
4. ‚è≥ **Phase 3 (REFACTOR)**: Clean up code
5. ‚è≥ **Phase 4**: Property tests
6. ‚è≥ **Phase 5**: Mutation testing
7. ‚è≥ **Phase 6**: Coverage analysis
8. ‚è≥ **Documentation**: Update book with examples

---

## References

- EXTREME TDD Methodology: `CLAUDE.md`
- CLI Testing Pattern: `rash/tests/cli_purify_tests.rs`
- Property Testing: `rash/src/bash_transpiler/purification_property_tests.rs`
- Mutation Testing: `mutation_codegen_baseline.log`

---

**END OF SPEC**
